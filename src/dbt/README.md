# Weather Analytics DBT Project

–ü—Ä–æ–µ–∫—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º dbt (data build tool).

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
- [–°–ª–æ–∏ –¥–∞–Ω–Ω—ã—Ö](#—Å–ª–æ–∏-–¥–∞–Ω–Ω—ã—Ö)
- [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
- [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–∫–∞—á–µ—Å—Ç–≤–∞)

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Ç—Ä–µ—Ö—Å–ª–æ–π–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É**:

```
RAW (PostgreSQL) ‚Üí STG (Views) ‚Üí ODS (Incremental) ‚Üí DM (Tables)
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:

1. **RAW** - —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ MongoDB (—á–µ—Ä–µ–∑ Airflow ETL)
2. **STG** - staging views –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSONB
3. **ODS** - operational data store —Å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
4. **DM** - data marts –¥–ª—è –¥–∞—à–±–æ—Ä–¥–æ–≤ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
models/
‚îú‚îÄ‚îÄ stg/                          # Staging layer (views)
‚îÇ   ‚îú‚îÄ‚îÄ stg_weather_current.sql   # –¢–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ stg_weather_forecast.sql  # –ü—Ä–æ–≥–Ω–æ–∑—ã –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ stg_schema.yml            # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ sources.yml               # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ ods/                          # Operational Data Store (incremental)
‚îÇ   ‚îú‚îÄ‚îÄ ods_weather_observations.sql  # –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ ods_weather_forecasts.sql     # –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã
‚îÇ   ‚îî‚îÄ‚îÄ ods_schema.yml                # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç—ã
‚îÇ
‚îî‚îÄ‚îÄ dm/                           # Data Marts (tables)
    ‚îú‚îÄ‚îÄ dm_forecast_accuracy_by_interval.sql  # –¢–æ—á–Ω–æ—Å—Ç—å –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º
    ‚îú‚îÄ‚îÄ dm_provider_ranking.sql               # –†–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
    ‚îú‚îÄ‚îÄ dm_city_weather_summary.sql           # –°–≤–æ–¥–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º
    ‚îî‚îÄ‚îÄ dm_schema.yml                         # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç—ã
```

## üéØ –°–ª–æ–∏ –¥–∞–Ω–Ω—ã—Ö

### STG (Staging)

**Materialization:** `view`  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–∞—Ä—Å–∏–Ω–≥ JSONB –∏–∑ raw —Ç–∞–±–ª–∏—Ü

- `stg_weather_current` - —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç samples –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
- `stg_weather_forecast` - —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç forecasts –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º –∏ —á–∞—Å–∞–º

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º (views)
- –ü–∞—Ä—Å–∏–Ω–≥ JSONB ‚Üí —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π (SCD Type 2)

### ODS (Operational Data Store)

**Materialization:** `incremental`  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –≤—ã—á–∏—Å–ª—è–µ–º—ã–º–∏ –ø–æ–ª—è–º–∏

- `ods_weather_observations` - –Ω–∞–±–ª—é–¥–µ–Ω–∏—è —Å —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
- `ods_weather_forecasts` - –ø—Ä–æ–≥–Ω–æ–∑—ã –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (1h, 3h, 6h, 12h, 24h, 48h)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (delete+insert, merge)
- –°—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ —á–µ—Ä–µ–∑ `dbt_utils.generate_surrogate_key()`
- –í—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ ¬∞F, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞)
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### DM (Data Marts)

**Materialization:** `table`  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –§–∏–Ω–∞–ª—å–Ω—ã–µ –≤–∏—Ç—Ä–∏–Ω—ã –¥–ª—è –¥–∞—à–±–æ—Ä–¥–æ–≤

- `dm_forecast_accuracy_by_interval` - –º–µ—Ç—Ä–∏–∫–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏ (MAE, RMSE, accuracy%)
- `dm_provider_ranking` - —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –ø–æ —Ç–æ—á–Ω–æ—Å—Ç–∏
- `dm_city_weather_summary` - –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–Ω–≥–æ–≤
- CTE –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
- –ì–æ—Ç–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –ó–∞–π—Ç–∏ –≤ dbt –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker compose exec dbt bash

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å dbt –ø–∞–∫–µ—Ç—ã
dbt deps

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
dbt debug
```

### 2. –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –º–æ–¥–µ–ª–∏ (—Å –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–æ–π)
dbt run --full-refresh

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
dbt test

# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
dbt docs generate
dbt docs serve --port 8080
```

### 3. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

```bash
# –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
dbt run

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–ª–æ–π
dbt run --select stg
dbt run --select ods
dbt run --select dm

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –º–æ–¥–µ–ª—å
dbt run --select dm_provider_ranking
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### dbt-core —Ç–µ—Å—Ç—ã

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å–µ 4 —Ç–∏–ø–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:

1. **unique** - —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–π
2. **not_null** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NULL
3. **accepted_values** - –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
4. **relationships** - —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
dbt test

# –¢–µ—Å—Ç—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ª–æ—è
dbt test --select ods

# –¢–µ—Å—Ç—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏
dbt test --select dm_provider_ranking
```

### Elementary —Ç–µ—Å—Ç—ã

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å–µ 6 —Ç–∏–ø–æ–≤ Elementary —Ç–µ—Å—Ç–æ–≤:

1. **freshness_anomalies** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
2. **volume_anomalies** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ä–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö
3. **column_anomalies** - –∞–Ω–æ–º–∞–ª–∏–∏ –≤ –∫–æ–ª–æ–Ω–∫–∞—Ö (min, max, null_count)
4. **dimension_anomalies** - –∞–Ω–æ–º–∞–ª–∏–∏ –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
5. **all_columns_anomalies** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫
6. **event_freshness_anomalies** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±—ã—Ç–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å Elementary —Ç–µ—Å—Ç—ã
dbt test --select tag:elementary
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞

### Elementary Report

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å elementary CLI (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
pip install elementary-data

# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
edr report

# –û—Ç–∫—Ä—ã—Ç—å –æ—Ç—á–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ
edr monitor --port 8081
```

### –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

Elementary –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç:
- –°–≤–µ–∂–µ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
- –û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π)
- –ê–Ω–æ–º–∞–ª–∏–∏ –≤ –∑–Ω–∞—á–µ–Ω–∏—è—Ö (–≤—ã–±—Ä–æ—Å—ã, NULL)
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã, –≥–æ—Ä–æ–¥–∞)
- –¢—Ä–µ–Ω–¥—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π

## üîß –ö–æ–º–∞–Ω–¥—ã dbt

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
dbt debug          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
dbt deps           # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
dbt compile        # –ö–æ–º–ø–∏–ª—è—Ü–∏—è –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
dbt run            # –ó–∞–ø—É—Å–∫ –º–æ–¥–µ–ª–µ–π
dbt test           # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
dbt docs generate  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
dbt clean          # –û—á–∏—Å—Ç–∫–∞
```

### –°–µ–ª–µ–∫—Ç–æ—Ä—ã

```bash
# –ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é
dbt run --select stg_weather_current

# –ü–æ —Ç–µ–≥—É
dbt run --select tag:ods

# –ü–æ –ø–∞–ø–∫–µ
dbt run --select models/dm

# –ì—Ä–∞—Ñ—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
dbt run --select +dm_provider_ranking  # –º–æ–¥–µ–ª—å + upstream
dbt run --select dm_provider_ranking+  # –º–æ–¥–µ–ª—å + downstream
```

### –§–ª–∞–≥–∏

```bash
--full-refresh     # –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞
--threads 8        # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏
--target prod      # –¶–µ–ª–µ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
--debug            # –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
```

## üìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–∏—Ç—Ä–∏–Ω

### –î–ª—è –¥–∞—à–±–æ—Ä–¥–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

```sql
-- –¢–æ—á–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º
SELECT * FROM dm.dm_forecast_accuracy_by_interval
WHERE hours_ahead_interval IN (1, 3, 6, 12, 24)
ORDER BY provider, hours_ahead_interval;

-- –û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
SELECT * FROM dm.dm_provider_ranking
ORDER BY overall_rank;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º
SELECT * FROM dm.dm_city_weather_summary
WHERE days_tracked > 30
ORDER BY total_observations DESC;
```

## üéì –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [dbt Documentation](https://docs.getdbt.com/)
- [Elementary Documentation](https://docs.elementary-data.com/)
- [dbt Utils Package](https://github.com/dbt-labs/dbt-utils)

---

**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-12
