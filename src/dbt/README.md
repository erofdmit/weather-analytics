# dbt –¥–ª—è Weather Analytics Platform

–ù–∞—Å—Ç—Ä–æ–∏–ª–∏ dbt –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ raw —Å–ª–æ—è –≤ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –≤–∏—Ç—Ä–∏–Ω—ã. –ü—Ä–æ–µ–∫—Ç –ª–µ–∂–∏—Ç –≤ `src/dbt/` –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Docker Compose –≤–º–µ—Å—Ç–µ —Å PostgreSQL.

–†–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ —Ç—Ä–∏ —Å–ª–æ—è: staging (–ø–∞—Ä—Å–∏–Ω–≥ JSONB –∏–∑ MongoDB –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏), marts (–ø–æ—á–∞—Å–æ–≤—ã–µ –∏ –¥–Ω–µ–≤–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã + —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≥–æ—Ä–æ–¥–æ–≤). –í—Å–µ marts –º–æ–¥–µ–ª–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ - –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏. –î–æ–±–∞–≤–∏–ª–∏ –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—é (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, NULL-–ø—Ä–æ–≤–µ—Ä–∫–∏). –í macros –≤—ã–Ω–µ—Å–ª–∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—É—é –ª–æ–≥–∏–∫—É: –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –≤ –§–∞—Ä–µ–Ω–≥–µ–π—Ç—ã, –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≥—Ä–∞–¥—É—Å–æ–≤ –≤–µ—Ç—Ä–∞ –≤ —Å—Ç–æ—Ä–æ–Ω—ã —Å–≤–µ—Ç–∞ (N/S/E/W), —Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SCD Type 2.

–ó–∞–ø—É—Å–∫: `docker exec weather_dbt dbt run`. –ü–æ—Å–ª–µ –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ ETL –∏–∑ Airflow –∑–∞–ø—É—Å–∫–∞–µ–º dbt –∏ –ø–æ–ª—É—á–∞–µ–º –≥–æ—Ç–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤ —Å—Ö–µ–º–µ `marts`. –ï—Å–ª–∏ –Ω–∞–¥–æ, —Ç–æ –º–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Airflow DAG —á–µ—Ä–µ–∑ BashOperator –∏–ª–∏ DockerOperator.

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
- [–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö](#–º–æ–¥–µ–ª–∏-–¥–∞–Ω–Ω—ã—Ö)
- [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- [–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞](#–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è-–∑–∞–≥—Ä—É–∑–∫–∞)
- [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Airflow](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-airflow)
- [–ö–æ–º–∞–Ω–¥—ã dbt](#–∫–æ–º–∞–Ω–¥—ã-dbt)

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **medallion architecture** —Å —Ç—Ä–µ–º—è —Å–ª–æ—è–º–∏:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              RAW Layer (PostgreSQL)              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ weather_current  ‚îÇ  ‚îÇ weather_forecast ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  (from MongoDB)  ‚îÇ  ‚îÇ  (from MongoDB)  ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          STAGING Layer (dbt views)              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ stg_weather_current  ‚îÇ  ‚îÇ stg_weather_    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö    ‚îÇ  ‚îÇ  forecast       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - –ø–∞—Ä—Å–∏–Ω–≥ JSONB     ‚îÇ  ‚îÇ  - —Ä–∞–∑–≤–µ—Ä—Ç–∫–∞    ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           MARTS Layer (dbt tables)              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ mart_weather_   ‚îÇ  ‚îÇ mart_weather_daily_  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  hourly         ‚îÇ  ‚îÇ  avg                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  (incremental)  ‚îÇ  ‚îÇ  (incremental)       ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
‚îÇ  ‚îÇ mart_cities     ‚îÇ                           ‚îÇ
‚îÇ  ‚îÇ  (dimension)    ‚îÇ                           ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –°–ª–æ–∏ –¥–∞–Ω–Ω—ã—Ö

1. **RAW Layer** (`raw` schema)
   - –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ MongoDB (—á–µ—Ä–µ–∑ Airflow ETL)
   - SCD Type 2 –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - JSONB —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏

2. **STAGING Layer** (`staging` schema)
   - Views –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
   - –û—á–∏—Å—Ç–∫–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
   - –ü–∞—Ä—Å–∏–Ω–≥ JSONB –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

3. **MARTS Layer** (`marts` schema)
   - –¢–∞–±–ª–∏—Ü—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ BI
   - –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
   - –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   - –ì–æ—Ç–æ–≤—ã–µ –≤–∏—Ç—Ä–∏–Ω—ã –¥–∞–Ω–Ω—ã—Ö

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose

```bash
# –ü–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é DWH
cd src/dwh

# –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω)
cp .env.example .env

# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å .env
nano .env

# –ó–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL –∏ dbt
docker compose up -d

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
docker compose ps
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ dbt –ø–∞–∫–µ—Ç–æ–≤

```bash
# –ó–∞–π—Ç–∏ –≤ dbt –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker compose exec dbt bash

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
dbt deps

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
dbt debug
```

### 3. –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –º–æ–¥–µ–ª–µ–π

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –º–æ–¥–µ–ª–∏
dbt run

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ staging –º–æ–¥–µ–ª–∏
dbt run --select staging

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ marts –º–æ–¥–µ–ª–∏
dbt run --select marts

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –º–æ–¥–µ–ª—å
dbt run --select mart_weather_hourly
```

### 4. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
dbt test

# –¢–µ—Å—Ç—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏
dbt test --select stg_weather_current

# –¢–µ—Å—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è marts
dbt test --select marts
```

## üìä –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### Staging –º–æ–¥–µ–ª–∏

#### `stg_weather_current`
–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ —Å –æ—á–∏—Å—Ç–∫–æ–π –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π.

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
- `weather_id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `city`, `country` - –ª–æ–∫–∞—Ü–∏—è
- `temperature_celsius`, `humidity_percent` - –ø–æ–≥–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- `updated_at` - –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –§–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (status_code = 200)
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ JSONB
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏ (SCD Type 2)

#### `stg_weather_forecast`
–ü—Ä–æ–≥–Ω–æ–∑—ã –ø–æ–≥–æ–¥—ã, —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –ø–æ —á–∞—Å–∞–º.

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
- `forecast_id` - ID –ø—Ä–æ–≥–Ω–æ–∑–∞
- `forecast_timestamp` - –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞
- `hour_offset` - —Å–º–µ—â–µ–Ω–∏–µ –≤ —á–∞—Å–∞—Ö (0, 1, 2, ...)
- –í—Å–µ –ø–æ–≥–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –º–∞—Å—Å–∏–≤ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
- –û–¥–∏–Ω –ø—Ä–æ–≥–Ω–æ–∑ ‚Üí N —Å—Ç—Ä–æ–∫ (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —á–∞—Å–æ–≤)

### Marts –º–æ–¥–µ–ª–∏

#### `mart_weather_hourly` (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è)
–û—Å–Ω–æ–≤–Ω–∞—è –≤–∏—Ç—Ä–∏–Ω–∞ –ø–æ—á–∞—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

**Materialization:** `incremental` (merge strategy)
**Unique key:** `[city, observation_timestamp]`

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ current + forecast
- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ ¬∞C –∏ ¬∞F
- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞ (–≥—Ä–∞–¥—É—Å—ã + —Å—Ç–æ—Ä–æ–Ω—ã —Å–≤–µ—Ç–∞)
- –°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞ –≤ –º/—Å –∏ –∫–º/—á
- –í—Å–µ –ø–æ–≥–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```sql
-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –ú–æ—Å–∫–≤–µ
SELECT * FROM marts.mart_weather_hourly
WHERE city = 'Moscow'
ORDER BY observation_timestamp DESC
LIMIT 24;
```

#### `mart_weather_daily_avg` (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è)
–î–Ω–µ–≤–Ω–∞—è –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.

**Materialization:** `incremental` (merge strategy)
**Unique key:** `[city, observation_date]`

**–ê–≥—Ä–µ–≥–∞—Ç—ã:**
- –°—Ä–µ–¥–Ω–∏–µ, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ, –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- –°—É–º–º–∞—Ä–Ω—ã–µ –æ—Å–∞–¥–∫–∏ –∑–∞ –¥–µ–Ω—å
- –†–∞–∑–±—Ä–æ—Å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä (temperature_range)
- –ù–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–æ–µ –ø–æ–≥–æ–¥–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```sql
-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä –ø–æ –≥–æ—Ä–æ–¥–∞–º –∑–∞ –Ω–µ–¥–µ–ª—é
SELECT
    city,
    observation_date,
    avg_temperature_celsius,
    temperature_range
FROM marts.mart_weather_daily_avg
WHERE observation_date >= CURRENT_DATE - 7
ORDER BY city, observation_date;
```

#### `mart_cities` (—Ç–∞–±–ª–∏—Ü–∞-—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫)
–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≥–æ—Ä–æ–¥–æ–≤ —Å –±–∞–∑–æ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π.

**Materialization:** `table` (–ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞)

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –≥–æ—Ä–æ–¥–æ–≤
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
- –ü–µ—Ä–∏–æ–¥ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π (first/last observation)
- –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Å—Ä–µ–¥–Ω–∏–µ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è)

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã dbt:
- `not_null` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NULL
- `unique` - —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–π
- `accepted_values` - –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- `relationships` - —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

### –¢–µ—Å—Ç—ã —Å dbt_utils

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –∏–∑ –ø–∞–∫–µ—Ç–∞ `dbt_utils`:
- `expression_is_true` - –∫–∞—Å—Ç–æ–º–Ω—ã–µ SQL —É—Å–ª–æ–≤–∏—è
  - –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ —Ä–∞–∑—É–º–Ω—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö (-100¬∞C –¥–æ 60¬∞C)
  - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –≤–∞–ª–∏–¥–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
  - –í–ª–∞–∂–Ω–æ—Å—Ç—å 0-100%

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞

```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã
dbt test

# –¢–æ–ª—å–∫–æ –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (raw tables)
dbt test --select source:*

# –° –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
dbt test --select mart_weather_daily_avg --store-failures

# –¢–æ–ª—å–∫–æ failed —Ç–µ—Å—Ç—ã
dbt test --select result:fail
```

### Elementary –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤

–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML –æ—Ç—á–µ—Ç–æ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å Elementary:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞
pip install elementary-data

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
edr report

# –û—Ç–∫—Ä—ã—Ç—å –æ—Ç—á–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ
edr monitor
```

## ‚ö° –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç —Ç–æ–ª—å–∫–æ **–Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ** —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—Å–∫–∞.

**–ü—Ä–∏–º–µ—Ä –∏–∑ `mart_weather_hourly`:**
```sql
{% if is_incremental() %}
    where updated_at > (select max(observation_timestamp) from {{ this }})
{% endif %}
```


### –ö–æ–º–∞–Ω–¥—ã

```bash
# –û–±—ã—á–Ω—ã–π –∑–∞–ø—É—Å–∫ (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ)
dbt run --select mart_weather_hourly

# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ (full-refresh)
dbt run --select mart_weather_hourly --full-refresh

# –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è marts
dbt run --select marts
```

### –°—Ç—Ä–∞—Ç–µ–≥–∏–∏

- **merge** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) - UPSERT –ª–æ–≥–∏–∫–∞
- **insert_overwrite** - –¥–ª—è –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
- **delete+insert** - —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ, –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Airflow

### –í–∞—Ä–∏–∞–Ω—Ç 1: PythonOperator

```python
from airflow import DAG
from airflow.operators.bash_operator import BashOperator
from datetime import datetime

with DAG(
    'dbt_weather_analytics',
    start_date=datetime(2025, 12, 1),
    schedule_interval='@hourly',
    catchup=False
) as dag:

    dbt_run = BashOperator(
        task_id='dbt_run',
        bash_command='cd /path/to/dbt && dbt run'
    )

    dbt_test = BashOperator(
        task_id='dbt_test',
        bash_command='cd /path/to/dbt && dbt test'
    )

    dbt_run >> dbt_test
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: DockerOperator

```python
from airflow.providers.docker.operators.docker import DockerOperator

dbt_run = DockerOperator(
    task_id='dbt_run',
    image='weather_dbt:latest',
    command='dbt run',
    network_mode='weather_dwh_network',
    environment={
        'POSTGRES_HOST': 'postgres',
        'POSTGRES_USER': '{{ var.value.postgres_user }}',
        'POSTGRES_PASSWORD': '{{ var.value.postgres_password }}',
        'POSTGRES_DB': 'weather_dwh'
    }
)
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: Cosmos

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ [Astronomer Cosmos](https://astronomer.github.io/astronomer-cosmos/):

```python
from cosmos import DbtTaskGroup, ProjectConfig, ProfileConfig

dbt_tg = DbtTaskGroup(
    project_config=ProjectConfig('/path/to/dbt'),
    profile_config=ProfileConfig(
        profile_name='weather_analytics',
        target_name='prod'
    ),
    operator_args={
        'install_deps': True
    }
)
```

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ pipeline

```
MongoDB ‚Üí Airflow ETL ‚Üí PostgreSQL (raw) ‚Üí dbt (staging + marts) ‚Üí BI Tools
```

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π DAG:
1. `extract_from_mongo` - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
2. `load_to_postgres` - –∑–∞–≥—Ä—É–∑–∫–∞ –≤ raw
3. `dbt_run_staging` - staging –º–æ–¥–µ–ª–∏
4. `dbt_run_marts` - marts –º–æ–¥–µ–ª–∏
5. `dbt_test` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
6. `send_metrics` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç—Ä–∏–∫

## üìù –ö–æ–º–∞–Ω–¥—ã dbt

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
dbt debug

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
dbt deps

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è –º–æ–¥–µ–ª–µ–π (–±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
dbt compile

# –ó–∞–ø—É—Å–∫ –º–æ–¥–µ–ª–µ–π
dbt run

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
dbt test

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
dbt docs generate

# –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
dbt docs serve --port 8080

# –û—á–∏—Å—Ç–∫–∞
dbt clean
```

### –°–µ–ª–µ–∫—Ç–æ—Ä—ã

```bash
# –ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é
dbt run --select stg_weather_current

# –ü–æ —Ç–µ–≥—É
dbt run --select tag:staging

# –ü–æ –ø–∞–ø–∫–µ
dbt run --select models/staging

# –ì—Ä–∞—Ñ—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
dbt run --select +mart_weather_hourly  # –º–æ–¥–µ–ª—å + –µ—ë upstream
dbt run --select mart_weather_hourly+  # –º–æ–¥–µ–ª—å + –µ—ë downstream
dbt run --select +mart_weather_hourly+ # –≤—Å—ë –¥–µ—Ä–µ–≤–æ

# –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏
dbt run --select tag:marts,+stg_weather_current
```

### –§–ª–∞–≥–∏

```bash
# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞
dbt run --full-refresh

# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
dbt run --select state:modified

# –î–µ–±–∞–≥ —Ä–µ–∂–∏–º
dbt run --debug

# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏
dbt run --threads 8

# –†–∞–±–æ—Ç–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º target
dbt run --target prod
```

## üîç SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞

### –ê–Ω–∞–ª–∏–∑ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö –∞–Ω–æ–º–∞–ª–∏–π
```sql
WITH daily_stats AS (
    SELECT
        city,
        observation_date,
        avg_temperature_celsius,
        AVG(avg_temperature_celsius) OVER (
            PARTITION BY city
            ORDER BY observation_date
            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ) as moving_avg_7d
    FROM marts.mart_weather_daily_avg
)
SELECT * FROM daily_stats
WHERE ABS(avg_temperature_celsius - moving_avg_7d) > 10
ORDER BY observation_date DESC;
```

### –¢–æ–ø-10 —Å–∞–º—ã—Ö –≤–µ—Ç—Ä–µ–Ω—ã—Ö –¥–Ω–µ–π
```sql
SELECT
    city,
    observation_date,
    max_wind_speed_ms,
    avg_wind_speed_ms
FROM marts.mart_weather_daily_avg
ORDER BY max_wind_speed_ms DESC
LIMIT 10;
```

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ —Å —Ñ–∞–∫—Ç–æ–º
```sql
SELECT
    f.city,
    DATE_TRUNC('hour', f.forecast_timestamp) as hour,
    f.temperature_celsius as forecast_temp,
    c.temperature_celsius as actual_temp,
    ABS(f.temperature_celsius - c.temperature_celsius) as error
FROM marts.mart_weather_hourly f
JOIN marts.mart_weather_hourly c
    ON f.city = c.city
    AND DATE_TRUNC('hour', f.forecast_timestamp) = DATE_TRUNC('hour', c.observation_timestamp)
    AND c.data_type = 'current'
WHERE f.data_type = 'forecast'
ORDER BY error DESC
LIMIT 20;
```

## üéì –°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É

- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è dbt](https://docs.getdbt.com/)
- [dbt Learn](https://courses.getdbt.com/)
- [dbt Discourse](https://discourse.getdbt.com/)
- [dbt Slack Community](https://www.getdbt.com/community/)


–ë–∞—Ç—É—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç üöÄ 
---
