# Weather Analytics Platform

Платформа для сбора, хранения и анализа данных о погоде от различных провайдеров с целью сравнения точности их прогнозов.

## 📋 Оглавление

- [Архитектура решения](#архитектура-решения)
- [Структура проекта](#структура-проекта)
- [Компоненты системы](#компоненты-системы)
- [Быстрый старт](#быстрый-старт)
- [Технологический стек](#технологический-стек)

## 🏗️ Архитектура решения

```
┌─────────────────────────────────────────────────────────────┐
│                    Weather API Providers                     │
│  (OpenMeteo, OpenWeatherMap, WeatherAPI, WeatherBit, etc.)  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    FastAPI Application                       │
│              (src/app - сбор данных)                         │
│  - Агрегация данных от провайдеров                          │
│  - REST API для запросов                                    │
│  - Кэширование и обработка ошибок                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      MongoDB (Raw Data)                      │
│              (Сырые данные в JSONB)                          │
│  - SCD Type 2 для истории изменений                         │
│  - Гибкая схема для разных провайдеров                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    Apache Airflow (ETL)                      │
│              (src/airflow - оркестрация)                     │
│  - Расписание загрузки данных                               │
│  - Перенос MongoDB → PostgreSQL                             │
│  - Запуск dbt трансформаций                                 │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   PostgreSQL (DWH/Raw)                       │
│              (src/dwh - хранилище данных)                    │
│  - Raw слой: данные из MongoDB                              │
│  - SCD Type 2 для отслеживания изменений                    │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    DBT (Transformations)                     │
│              (src/dbt - трансформации)                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ STG: Парсинг JSONB → структурированные данные       │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ODS: Нормализация и обогащение данных               │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ DM: Финальные витрины для аналитики                 │   │
│  │  - Точность прогнозов по интервалам                 │   │
│  │  - Рейтинг провайдеров                               │   │
│  │  - Статистика по городам                             │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    BI Tools / Dashboards                     │
│  - Сравнение точности провайдеров                           │
│  - Анализ погодных трендов                                  │
│  - Мониторинг качества данных (Elementary)                  │
└─────────────────────────────────────────────────────────────┘
```

## 📁 Структура проекта

```
weather-analytics/
├── src/
│   ├── app/                    # FastAPI приложение
│   │   ├── api/                # REST API endpoints
│   │   ├── services/           # Бизнес-логика
│   │   ├── models/             # Pydantic модели
│   │   └── main.py             # Точка входа
│   │
│   ├── airflow/                # Apache Airflow DAGs
│   │   ├── dags/               # ETL pipeline DAGs
│   │   ├── plugins/            # Кастомные операторы
│   │   └── docker-compose.yml  # Airflow setup
│   │
│   ├── dwh/                    # Data Warehouse (PostgreSQL)
│   │   ├── docker-compose.yml  # PostgreSQL + dbt setup
│   │   └── init/               # Инициализация схем
│   │
│   └── dbt/                    # DBT проект
│       ├── models/             # SQL модели
│       │   ├── stg/            # Staging layer
│       │   ├── ods/            # Operational Data Store
│       │   └── dm/             # Data Marts
│       ├── tests/              # Кастомные тесты
│       ├── macros/             # Переиспользуемые макросы
│       └── README.md           # Документация dbt
│
├── docker-compose.yml          # Общий docker compose
└── README.md                   # Этот файл
```

## 🔧 Компоненты системы

### 1. FastAPI Application (`src/app`)

**Назначение:** Сбор данных от провайдеров погоды

**Функциональность:**
- Агрегация данных от 5+ провайдеров
- REST API для запросов текущей погоды и прогнозов
- Кэширование для оптимизации запросов
- Обработка ошибок и retry логика

**Технологии:** FastAPI, Pydantic, aiohttp, MongoDB

### 2. Apache Airflow (`src/airflow`)

**Назначение:** Оркестрация ETL процессов

**Функциональность:**
- Расписание загрузки данных (hourly/daily)
- Перенос данных MongoDB → PostgreSQL
- Запуск dbt трансформаций
- Мониторинг и алертинг

**Технологии:** Apache Airflow, Python, Docker

### 3. PostgreSQL DWH (`src/dwh`)

**Назначение:** Хранилище данных

**Структура:**
- **raw** схема - сырые данные из MongoDB
- **stg** схема - staging views
- **ods** схема - нормализованные данные
- **dm** схема - финальные витрины
- **elementary** схема - мониторинг качества

**Технологии:** PostgreSQL 16, Docker

### 4. DBT Project (`src/dbt`)

**Назначение:** Трансформация данных

**Слои:**
- **STG** - парсинг JSONB, views
- **ODS** - нормализация, инкрементальные таблицы
- **DM** - агрегация, финальные витрины

**Особенности:**
- Инкрементальная загрузка (delete+insert, merge)
- Все 4 типа dbt-core тестов
- Все 6 типов Elementary тестов
- Полная документация моделей
- Теги для организации

**Технологии:** dbt-core, dbt-postgres, elementary-data

## 🚀 Быстрый старт

### Предварительные требования

- Docker & Docker Compose
- Python 3.11+
- 8GB RAM минимум

### 1. Клонирование и настройка

```bash
# Клонировать репозиторий
git clone <repository-url>
cd weather-analytics

# Создать .env файлы
cp src/app/.env.example src/app/.env
cp src/dwh/.env.example src/dwh/.env
cp src/airflow/.env.example src/airflow/.env

# Отредактировать .env файлы с вашими настройками
```

### 2. Запуск компонентов

```bash
# Запустить PostgreSQL и dbt
cd src/dwh
docker compose up -d

# Запустить FastAPI приложение
cd ../app
docker compose up -d

# Запустить Airflow
cd ../airflow
docker compose up -d
```

### 3. Инициализация dbt

```bash
# Зайти в dbt контейнер
docker compose exec dbt bash

# Установить пакеты
dbt deps

# Запустить модели
dbt run --full-refresh

# Запустить тесты
dbt test

# Сгенерировать документацию
dbt docs generate
dbt docs serve --port 8080
```

### 4. Проверка работы

```bash
# FastAPI docs
open http://localhost:8000/docs

# Airflow UI
open http://localhost:8080

# dbt docs
open http://localhost:8081

# Elementary report
edr monitor --port 8082
```

## 🛠️ Технологический стек

### Backend
- **FastAPI** - REST API
- **Pydantic** - валидация данных
- **aiohttp** - асинхронные HTTP запросы

### Databases
- **MongoDB** - хранение сырых данных
- **PostgreSQL 16** - DWH

### Data Pipeline
- **Apache Airflow** - оркестрация ETL
- **dbt-core** - трансформации данных
- **elementary-data** - мониторинг качества

### DevOps
- **Docker & Docker Compose** - контейнеризация
- **pre-commit** - линтеры и форматтеры
- **pytest** - тестирование

### Monitoring & Quality
- **Elementary** - data quality monitoring
- **dbt tests** - валидация данных
- **Airflow monitoring** - pipeline observability

## 📊 Цель проекта

**Основная задача:** Сравнение точности прогнозов погоды от разных провайдеров

**Метрики сравнения:**
- MAE (Mean Absolute Error) - средняя абсолютная ошибка
- RMSE (Root Mean Square Error) - среднеквадратичная ошибка
- Accuracy % - процент точных прогнозов (±2°C, ±5°C)
- Сравнение по временным интервалам (1h, 3h, 6h, 12h, 24h, 48h)

**Витрины для анализа:**
1. `dm_forecast_accuracy_by_interval` - точность по интервалам
2. `dm_provider_ranking` - общий рейтинг провайдеров
3. `dm_city_weather_summary` - статистика по городам

## 📚 Документация

- [DBT Project README](src/dbt/README.md) - детальная документация dbt проекта
- [API Documentation](http://localhost:8000/docs) - FastAPI Swagger docs
- [DBT Docs](http://localhost:8081) - автогенерируемая документация моделей
- [Elementary Report](http://localhost:8082) - отчет о качестве данных

## 🧪 Тестирование

### dbt тесты

```bash
# Все тесты
dbt test

# По слоям
dbt test --select stg
dbt test --select ods
dbt test --select dm

# Elementary тесты
dbt test --select tag:elementary
```

### Python тесты

```bash
# Unit тесты
pytest src/app/tests/

# Integration тесты
pytest src/app/tests/integration/
```

## 🔐 Best Practices

✅ **Реализовано:**
- Трехслойная архитектура (STG → ODS → DM)
- Инкрементальная загрузка данных
- Все типы dbt-core и Elementary тестов
- Полная документация моделей
- Теги для организации
- Jinja-шаблоны в каждой модели
- Оконные функции и CTE
- Комментарии в сложных местах
- Pre-commit хуки (линтеры, форматтеры)
- Единообразное форматирование SQL

## 📈 Roadmap

- [ ] Добавить больше провайдеров погоды
- [ ] Реализовать ML модели для прогнозирования
- [ ] Создать Grafana дашборды
- [ ] Добавить алертинг в Telegram/Slack
- [ ] Оптимизация производительности запросов

---

**Версия:** 1.0.0  
**Последнее обновление:** 2025-12-12  
**Автор:** Weather Analytics Team
